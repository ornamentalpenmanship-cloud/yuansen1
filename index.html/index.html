<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0f0f0f">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="æºæ£®AI">
<title>æºæ£®AI</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Space+Mono:wght@400;700&display=swap');
  :root {
    --bg:#0f0f0f;--surface:#1a1a1a;--surface2:#242424;--border:#2e2e2e;
    --accent:#c8ff00;--accent-dim:rgba(200,255,0,0.12);--accent-dim2:rgba(200,255,0,0.06);
    --text:#e8e8e8;--text-dim:#888;--text-dimmer:#555;
    --user-bg:#1e2a1a;--user-border:rgba(200,255,0,0.25);--radius:18px;
  }
  .light {
    --bg:#f5f5f5;--surface:#ffffff;--surface2:#eeeeee;--border:#ddd;
    --accent:#5a8a00;--accent-dim:rgba(90,138,0,0.12);--accent-dim2:rgba(90,138,0,0.06);
    --text:#111;--text-dim:#555;--text-dimmer:#aaa;
    --user-bg:#e8f5d0;--user-border:rgba(90,138,0,0.3);
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  html,body{height:100%;font-family:'Noto Sans SC',sans-serif;background:var(--bg);color:var(--text);overflow:hidden;transition:background 0.3s,color 0.3s;}
  #app{display:flex;height:100dvh;max-width:900px;margin:0 auto;position:relative;}

  /* â”€â”€ Sidebar â”€â”€ */
  #sidebar{width:260px;flex-shrink:0;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;transition:transform 0.25s ease;z-index:50;}
  #sidebar.hidden{display:none;}
  .sidebar-header{padding:18px 16px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
  .sidebar-logo{font-weight:700;font-size:16px;color:var(--accent);}
  .sidebar-close{background:none;border:none;color:var(--text-dim);font-size:20px;cursor:pointer;}
  .new-chat-btn{margin:12px;background:var(--accent);border:none;color:#000;font-weight:700;font-size:14px;padding:10px;border-radius:12px;cursor:pointer;font-family:inherit;transition:opacity 0.2s;}
  .new-chat-btn:hover{opacity:0.85;}

  .sidebar-section{padding:8px 12px 4px;font-size:11px;color:var(--text-dimmer);letter-spacing:0.05em;}
  .session-list{flex:1;overflow-y:auto;padding:0 8px;}
  .session-item{padding:10px 12px;border-radius:10px;cursor:pointer;font-size:13px;color:var(--text-dim);transition:all 0.15s;display:flex;align-items:center;gap:8px;margin-bottom:2px;}
  .session-item:hover{background:var(--surface2);}
  .session-item.active{background:var(--accent-dim);color:var(--accent);border:1px solid rgba(200,255,0,0.2);}
  .session-icon{font-size:16px;flex-shrink:0;}
  .session-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

  /* èº«ä»½é€‰æ‹© */
  .identity-section{padding:12px;border-top:1px solid var(--border);}
  .identity-label{font-size:11px;color:var(--text-dimmer);margin-bottom:8px;}
  .identity-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
  .identity-btn{background:var(--surface2);border:1px solid var(--border);color:var(--text-dim);padding:8px 6px;border-radius:10px;font-size:12px;cursor:pointer;font-family:inherit;text-align:center;transition:all 0.2s;line-height:1.4;}
  .identity-btn:hover,.identity-btn.active{background:var(--accent-dim);border-color:var(--accent);color:var(--accent);}
  .identity-btn span{display:block;font-size:18px;margin-bottom:2px;}

  /* åº•éƒ¨è®¾ç½® */
  .sidebar-footer{padding:12px;border-top:1px solid var(--border);display:flex;gap:8px;}
  .footer-btn{flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text-dim);padding:8px;border-radius:10px;font-size:12px;cursor:pointer;font-family:inherit;text-align:center;transition:all 0.2s;}
  .footer-btn:hover{border-color:var(--accent);color:var(--accent);}

  /* â”€â”€ Main chat area â”€â”€ */
  #main{flex:1;display:flex;flex-direction:column;min-width:0;}

  #header{flex-shrink:0;display:flex;align-items:center;gap:10px;padding:14px 16px 12px;border-bottom:1px solid var(--border);background:var(--bg);z-index:10;}
  .menu-btn{background:none;border:none;color:var(--text-dim);font-size:22px;cursor:pointer;padding:2px 6px;border-radius:8px;transition:color 0.2s;}
  .menu-btn:hover{color:var(--accent);}
  .avatar{width:36px;height:36px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;box-shadow:0 0 14px rgba(200,255,0,0.3);}
  .header-info{flex:1;}
  .header-name{font-weight:700;font-size:15px;color:var(--text);}
  .header-status{font-size:11px;color:var(--accent);display:flex;align-items:center;gap:4px;margin-top:1px;}
  .status-dot{width:5px;height:5px;background:var(--accent);border-radius:50%;animation:pulse 2s infinite;}
  @keyframes pulse{0%,100%{opacity:1;transform:scale(1);}50%{opacity:0.5;transform:scale(0.8);}}
  .header-badge{background:var(--accent-dim);border:1px solid rgba(200,255,0,0.3);color:var(--accent);padding:3px 9px;border-radius:20px;font-size:11px;font-family:'Space Mono',monospace;}
  .theme-btn{background:none;border:none;color:var(--text-dim);font-size:18px;cursor:pointer;padding:4px;border-radius:8px;transition:color 0.2s;}
  .theme-btn:hover{color:var(--accent);}

  #messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:14px;scroll-behavior:smooth;}
  #messages::-webkit-scrollbar{width:4px;}
  #messages::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}

  .msg{display:flex;gap:8px;animation:fadeUp 0.18s ease;will-change:transform,opacity;transform:translateZ(0);}
  @keyframes fadeUp{from{opacity:0;transform:translate3d(0,8px,0);}to{opacity:1;transform:translate3d(0,0,0);}}
  .msg.user{flex-direction:row-reverse;}
  .msg-avatar{width:30px;height:30px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:13px;margin-top:2px;}
  .msg.ai .msg-avatar{background:var(--surface2);border:1px solid var(--border);}
  .msg.user .msg-avatar{background:var(--accent);}
  .msg-body{max-width:76%;display:flex;flex-direction:column;gap:3px;}
  .msg.user .msg-body{align-items:flex-end;}
  .msg-bubble{padding:11px 15px;border-radius:var(--radius);font-size:14.5px;line-height:1.65;word-break:break-word;position:relative;cursor:pointer;}
  .msg.ai .msg-bubble{background:var(--surface);border:1px solid var(--border);border-bottom-left-radius:4px;}
  .msg.user .msg-bubble{background:var(--user-bg);border:1px solid var(--user-border);border-bottom-right-radius:4px;color:var(--text);}
  .msg-time{font-size:10px;color:var(--text-dimmer);padding:0 4px;font-family:'Space Mono',monospace;}
  .msg-bubble p{margin:0 0 8px;}.msg-bubble p:last-child{margin:0;}
  .msg-bubble strong{color:var(--accent);font-weight:700;}
  .msg-bubble ul,.msg-bubble ol{padding-left:18px;margin:6px 0;}
  .msg-bubble li{margin:3px 0;}
  .msg-bubble code{background:rgba(200,255,0,0.1);color:var(--accent);padding:1px 6px;border-radius:4px;font-family:'Space Mono',monospace;font-size:13px;}
  .msg-bubble pre{background:#111;border:1px solid var(--border);border-radius:8px;padding:12px;overflow-x:auto;margin:8px 0;}
  .msg-bubble pre code{background:none;padding:0;color:#b0ffa0;}
  .msg-bubble a{color:var(--accent);text-decoration:underline;}

  /* æ¶ˆæ¯æ“ä½œæ  */
  .msg-actions{display:none;gap:6px;padding:2px 4px;}
  .msg-body:hover .msg-actions{display:flex;}
  .msg-action-btn{background:var(--surface2);border:1px solid var(--border);color:var(--text-dim);padding:3px 10px;border-radius:20px;font-size:11px;cursor:pointer;font-family:inherit;transition:all 0.15s;white-space:nowrap;}
  .msg-action-btn:hover{border-color:var(--accent);color:var(--accent);}

  /* å›¾ç‰‡æ¶ˆæ¯ */
  .msg-image{max-width:200px;border-radius:12px;border:1px solid var(--border);display:block;margin-bottom:4px;}

  /* Typing */
  .typing-indicator{display:flex;gap:5px;align-items:center;padding:12px 15px;}
  .typing-dot{width:7px;height:7px;background:var(--accent);border-radius:50%;animation:bounce 1.2s infinite;opacity:0.7;will-change:transform;}
  .typing-dot:nth-child(2){animation-delay:0.2s;}.typing-dot:nth-child(3){animation-delay:0.4s;}
  @keyframes bounce{0%,60%,100%{transform:translate3d(0,0,0);}30%{transform:translate3d(0,-6px,0);opacity:1;}}

  #scroll-btn{position:absolute;bottom:90px;right:16px;width:36px;height:36px;background:var(--surface2);border:1px solid var(--border);border-radius:50%;color:var(--accent);font-size:16px;cursor:pointer;display:none;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(0,0,0,0.4);transition:all 0.2s;z-index:20;}
  #scroll-btn:hover{background:var(--accent);color:#000;}
  #scroll-btn.visible{display:flex;}

  #quick-replies{flex-shrink:0;display:flex;gap:8px;padding:8px 16px 4px;overflow-x:auto;scrollbar-width:none;}
  #quick-replies::-webkit-scrollbar{display:none;}
  .qr-btn{flex-shrink:0;background:var(--accent-dim2);border:1px solid var(--border);color:var(--text-dim);padding:6px 14px;border-radius:20px;font-size:12px;cursor:pointer;font-family:inherit;white-space:nowrap;transition:all 0.2s;}
  .qr-btn:hover,.qr-btn:active{background:var(--accent-dim);border-color:var(--accent);color:var(--accent);}

  /* Input */
  #input-area{flex-shrink:0;display:flex;align-items:flex-end;gap:8px;padding:8px 14px 14px;border-top:1px solid var(--border);background:var(--bg);}
  #user-input{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-family:inherit;font-size:15px;line-height:1.5;padding:10px 14px;resize:none;outline:none;max-height:120px;overflow-y:auto;transition:border-color 0.2s;}
  #user-input::placeholder{color:var(--text-dimmer);}
  #user-input:focus{border-color:rgba(200,255,0,0.4);}
  .input-btn{width:42px;height:42px;background:var(--surface2);border:1px solid var(--border);border-radius:50%;color:var(--text-dim);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.15s;}
  .input-btn:hover{border-color:var(--accent);color:var(--accent);}
  #img-input{display:none;}
  #send-btn{width:42px;height:42px;background:var(--accent);border:none;border-radius:50%;color:#000;font-size:19px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.15s;box-shadow:0 0 14px rgba(200,255,0,0.25);}
  #send-btn:hover{transform:scale(1.08);}
  #send-btn:active{transform:scale(0.95);}
  #send-btn:disabled{opacity:0.4;cursor:not-allowed;transform:none;}

  /* å›¾ç‰‡é¢„è§ˆ */
  #img-preview-wrap{display:none;padding:6px 14px 0;position:relative;width:fit-content;}
  #img-preview-wrap.show{display:block;}
  #img-preview{height:60px;border-radius:10px;border:1px solid var(--border);}
  #img-remove{position:absolute;top:2px;right:10px;width:18px;height:18px;background:#333;border:none;border-radius:50%;color:#fff;font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;}

  /* Welcome */
  #welcome{display:flex;flex-direction:column;align-items:center;text-align:center;padding:40px 24px 20px;gap:12px;}
  .welcome-icon{width:64px;height:64px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:30px;margin-bottom:4px;animation:glow 3s infinite;will-change:box-shadow;transform:translateZ(0);}
  @keyframes glow{0%,100%{box-shadow:0 0 30px rgba(200,255,0,0.3);}50%{box-shadow:0 0 55px rgba(200,255,0,0.55);}}
  .welcome-title{font-size:20px;font-weight:700;}
  .welcome-sub{font-size:14px;color:var(--text-dim);line-height:1.6;max-width:280px;}

  .memory-toast{background:var(--accent-dim);border:1px solid rgba(200,255,0,0.2);border-radius:10px;padding:7px 14px;font-size:12px;color:var(--accent);text-align:center;margin:0 auto;animation:fadeUp 0.3s ease;}
  .error-toast{background:rgba(255,100,100,0.1);border:1px solid rgba(255,100,100,0.3);border-radius:10px;padding:10px 14px;font-size:13px;color:#ff8080;text-align:center;margin:0 auto;display:flex;align-items:center;gap:10px;}
  .retry-btn{background:rgba(255,100,100,0.2);border:1px solid rgba(255,100,100,0.4);color:#ff8080;padding:4px 12px;border-radius:20px;font-size:12px;cursor:pointer;font-family:inherit;}

  #loading{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;z-index:999;}
  #loading.hidden{display:none;}
  .loading-icon{width:56px;height:56px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:26px;animation:glow 2s infinite;will-change:box-shadow;transform:translateZ(0);}
  .loading-text{color:var(--text-dim);font-size:14px;}

  #expired{position:fixed;inset:0;background:var(--bg);display:none;flex-direction:column;align-items:center;justify-content:center;gap:18px;z-index:998;padding:40px 32px;text-align:center;}
  #expired.show{display:flex;}
  .expired-icon{font-size:60px;}
  .expired-title{font-size:22px;font-weight:700;}
  .expired-sub{font-size:14px;color:var(--text-dim);line-height:1.8;max-width:280px;}
  .expired-tag{font-size:13px;color:#ff6b6b;background:rgba(255,107,107,0.1);border:1px solid rgba(255,107,107,0.3);padding:8px 20px;border-radius:20px;}
  .expired-contact{font-size:13px;color:var(--accent);background:var(--accent-dim);border:1px solid rgba(200,255,0,0.3);padding:10px 24px;border-radius:20px;}

  /* Copy toast */
  #copy-toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:8px 18px;border-radius:20px;font-size:13px;opacity:0;transition:opacity 0.3s;z-index:100;pointer-events:none;}
  #copy-toast.show{opacity:1;}


  /* è‡ªå®šä¹‰èº«ä»½å¼¹çª— */
  #custom-modal{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:flex-end;justify-content:center;z-index:200;}
  #custom-modal.open{display:flex;}
  .modal-box{background:var(--surface);border:1px solid var(--border);border-radius:20px 20px 0 0;padding:24px 20px 32px;width:100%;max-width:780px;animation:slideUp 0.2s ease;will-change:transform;}
  @keyframes slideUp{from{transform:translate3d(0,100%,0);}to{transform:translate3d(0,0,0);}}
  .modal-title{font-weight:700;font-size:16px;margin-bottom:18px;display:flex;justify-content:space-between;align-items:center;}
  .modal-close{background:none;border:none;color:var(--text-dim);font-size:20px;cursor:pointer;}
  .field{margin-bottom:14px;}
  .field label{display:block;font-size:12px;color:var(--text-dim);margin-bottom:6px;}
  .field input,.field textarea{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:inherit;font-size:14px;padding:10px 14px;outline:none;}
  .field textarea{resize:vertical;min-height:80px;}
  .field input:focus,.field textarea:focus{border-color:rgba(200,255,0,0.4);}
  .emoji-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;}
  .emoji-opt{width:36px;height:36px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s;}
  .emoji-opt.selected,.emoji-opt:hover{border-color:var(--accent);background:var(--accent-dim);}
  .modal-save{width:100%;background:var(--accent);border:none;color:#000;font-weight:700;font-size:15px;padding:13px;border-radius:12px;cursor:pointer;font-family:inherit;margin-top:4px;transition:opacity 0.2s;}
  .modal-save:hover{opacity:0.88;}

  /* Mobile sidebar overlay */
  #sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:49;}
  #sidebar-overlay.show{display:block;}

  @media(max-width:600px){
    #sidebar{position:fixed;left:0;top:0;bottom:0;transform:translateX(-100%);}
    #sidebar.mobile-open{transform:translateX(0);display:flex;}
  }

  /* éšç§æç¤º */
  .privacy-note{font-size:11px;color:var(--text-dimmer);text-align:center;padding:4px 16px 2px;}
</style>
</head>
<body>

<div id="loading">
  <div class="loading-icon">ğŸŒ¿</div>
  <div class="loading-text">æ­£åœ¨åŠ è½½æºæ£®AIâ€¦</div>
</div>

<div id="expired">
  <div class="expired-icon">ğŸ”’</div>
  <div class="expired-title">è¯•ç”¨å·²åˆ°æœŸ</div>
  <div class="expired-sub">æ‚¨çš„ä¸“å±AIåŠ©æ‰‹è¯•ç”¨æœŸå·²ç»“æŸï¼Œå¦‚éœ€ç»§ç»­ä½¿ç”¨è¯·è”ç³»æœåŠ¡å•†å¼€é€šæ­£å¼ç‰ˆã€‚</div>
  <div class="expired-tag">æœåŠ¡å·²æš‚åœ</div>
  <div class="expired-contact">è¯·è”ç³»æ‚¨çš„æœåŠ¡å•†ç»­è´¹</div>
</div>

<div id="copy-toast">å·²å¤åˆ¶</div>
<div id="sidebar-overlay" onclick="closeSidebar()"></div>

<div id="app">
  <!-- Sidebar -->
  <div id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">ğŸŒ¿ æºæ£®AI</div>
      <button class="sidebar-close" onclick="closeSidebar()">âœ•</button>
    </div>
    <button class="new-chat-btn" onclick="newSession()">ï¼‹ æ–°å»ºå¯¹è¯</button>

    <div class="sidebar-section">å¯¹è¯è®°å½•</div>
    <div class="session-list" id="session-list"></div>

    <div class="identity-section">
      <div class="identity-label">åˆ‡æ¢èº«ä»½</div>
      <div class="identity-grid" id="identity-grid"></div>
    </div>

    <div class="sidebar-footer">
      <button class="footer-btn" onclick="clearHistory()">ğŸ—‘ æ¸…é™¤è®°å½•</button>
      <button class="footer-btn" onclick="exportChat()">ğŸ“‹ å¯¼å‡ºèŠå¤©</button>
      <button class="footer-btn" onclick="openCustomModal()">âš™ï¸ è‡ªå®šä¹‰</button>
    </div>
  </div>

  <!-- Main -->
  <div id="main">
    <div id="header">
      <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>
      <div class="avatar">ğŸŒ¿</div>
      <div class="header-info">
        <div class="header-name">æºæ£®AI</div>
        <div class="header-status"><span class="status-dot"></span><span id="identity-label">ç§äººåŠ©æ‰‹</span></div>
      </div>
      <div class="header-badge" id="merchant-badge">åŠ è½½ä¸­â€¦</div>
      <button class="theme-btn" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">â˜€ï¸</button>
    </div>

    <div id="messages">
      <div id="welcome">
        <div class="welcome-icon">ğŸŒ¿</div>
        <div class="welcome-title">ä½ å¥½ï¼Œæˆ‘æ˜¯æºæ£®AI</div>
        <div class="welcome-sub">ä½ çš„ä¸“å±ç§äººåŠ©æ‰‹ï¼Œè®°ä½æ¯æ¬¡å¯¹è¯ï¼Œè¶Šç”¨è¶Šæ‡‚ä½ ï½</div>
      </div>
    </div>

    <div class="privacy-note">ğŸ”’ å¯¹è¯æ•°æ®ä»…ç”¨äºä¸ºæ‚¨æä¾›æœåŠ¡ï¼Œä¸ä¼šç”¨äºå…¶ä»–ç”¨é€”</div>

    <button id="scroll-btn" onclick="scrollToBottom(true)">â†“</button>

    <div id="quick-replies"></div>

    <div id="img-preview-wrap">
      <img id="img-preview" src="" alt="é¢„è§ˆ">
      <button id="img-remove" onclick="removeImage()">âœ•</button>
    </div>

    <div id="input-area">
      <button class="input-btn" onclick="document.getElementById('img-input').click()" title="å‘é€å›¾ç‰‡">ï¼‹</button>
      <input type="file" id="img-input" accept="image/*">
      <button class="input-btn" id="voice-btn" title="è¯­éŸ³è¾“å…¥">ğŸ¤</button>
      <textarea id="user-input" placeholder="æœ‰ä»€ä¹ˆéœ€è¦å¸®å¿™çš„ï¼Ÿ" rows="1"></textarea>
      <button id="send-btn" onclick="sendMessage()">â†‘</button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://jppkusvirfndmgtxbjnl.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpwcGt1c3ZpcmZuZG1ndHhiam5sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3OTAyODEsImV4cCI6MjA4NzM2NjI4MX0.ZfKK_mYLW0jUlslbZtk2yCXwIwWdpHob-LWAGuXHPrg';
const DEEPSEEK_KEY = 'sk-ef8ae6dba496408785a9cb88a85c816b';
const QWEN_KEY = 'sk-7489ce241f4c4ba7b9b6b5bb040b1aef';

// èº«ä»½é…ç½®
const IDENTITIES = [
  { id: 'merchant', icon: 'ğŸ›ï¸', name: 'ç”µå•†åŠ©æ‰‹', prompt: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç”µå•†åŠ©æ‰‹ï¼Œåªè´Ÿè´£å¸®å•†å®¶å†™äº§å“æ–‡æ¡ˆã€ç­–åˆ’ä¿ƒé”€æ´»åŠ¨ã€å›å¤ä¹°å®¶æ¶ˆæ¯ã€‚ä¸æ¶‰åŠç”µå•†ä»¥å¤–çš„è¯é¢˜ã€‚è¯­æ°”äº²åˆ‡è‡ªç„¶ï¼Œå›å¤ç®€æ´å®ç”¨ã€‚', quickReplies: ['âœï¸ æ–°å“æ–‡æ¡ˆ','ğŸ“¦ å‘è´§å›å¤','ğŸ’¬ ä»·æ ¼å¼‚è®®','ğŸ”¥ ä¿ƒé”€æ–‡æ¡ˆ','ğŸ™ å”®åå®‰æŠš'] },
  { id: 'life', icon: 'ğŸŒ±', name: 'ç”Ÿæ´»åŠ©æ‰‹', prompt: 'ä½ æ˜¯ä¸€ä¸ªè´´å¿ƒçš„ç”Ÿæ´»åŠ©æ‰‹ã€‚ä½ åªå…³æ³¨æ—¥å¸¸ç”Ÿæ´»è¯é¢˜ï¼ŒåŒ…æ‹¬é¥®é£Ÿã€å¥åº·ã€å®¶å±…ã€è´­ç‰©ã€å‡ºè¡Œã€å…´è¶£çˆ±å¥½ç­‰ã€‚ä¸æ¶‰åŠå·¥ä½œã€ç”µå•†ã€å­¦ä¹ ç­‰å…¶ä»–é¢†åŸŸã€‚è¯­æ°”æ¸©æš–è½»æ¾ï¼Œåƒä¸€ä¸ªæ‡‚ç”Ÿæ´»çš„æœ‹å‹ã€‚', quickReplies: ['ğŸ³ ä»Šå¤©åƒä»€ä¹ˆ','ğŸ’ª è¿åŠ¨å»ºè®®','ğŸ›’ è´­ç‰©æ¸…å•','ğŸ˜´ æ”¹å–„ç¡çœ '] },
  { id: 'work', icon: 'ğŸ’¼', name: 'å·¥ä½œåŠ©æ‰‹', prompt: 'ä½ æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„å·¥ä½œåŠ©æ‰‹ï¼Œä¸“æ³¨äºèŒåœºç›¸å…³å†…å®¹ï¼šå†™æŠ¥å‘Šã€æ•´ç†ä¼šè®®è®°å½•ã€åˆ†æé—®é¢˜ã€åˆ¶å®šå·¥ä½œè®¡åˆ’ã€å†™é‚®ä»¶ã€‚ä¸æ¶‰åŠç”Ÿæ´»å¨±ä¹ã€ç”µå•†ç­‰è¯é¢˜ã€‚è¯­æ°”ä¸“ä¸šä¸¥è°¨ï¼Œå›å¤æ¡ç†æ¸…æ™°ã€‚', quickReplies: ['ğŸ“Š å†™å·¥ä½œæŠ¥å‘Š','ğŸ“ æ•´ç†ä¼šè®®è®°å½•','ğŸ¯ åˆ¶å®šè®¡åˆ’','ğŸ“§ å†™é‚®ä»¶'] },
  { id: 'study', icon: 'ğŸ“š', name: 'å­¦ä¹ åŠ©æ‰‹', prompt: 'ä½ æ˜¯ä¸€ä¸ªè€å¿ƒçš„å­¦ä¹ åŠ©æ‰‹ï¼Œä¸“æ³¨äºå­¦ä¹ ç›¸å…³å†…å®¹ï¼šè§£é‡ŠçŸ¥è¯†æ¦‚å¿µã€è¾…å¯¼ä½œä¸šã€åˆ¶å®šå­¦ä¹ è®¡åˆ’ã€çŸ¥è¯†æ€»ç»“ã€‚ä¸æ¶‰åŠå¨±ä¹ã€ç”µå•†ã€å·¥ä½œç­‰è¯é¢˜ã€‚è¯­æ°”é¼“åŠ±æ­£å‘ï¼Œå–„äºç”¨ä¾‹å­è§£é‡Šéš¾ç‚¹ã€‚', quickReplies: ['ğŸ”¢ è§£é¢˜æ€è·¯','ğŸ“– æ¦‚å¿µè§£é‡Š','ğŸ“… å­¦ä¹ è®¡åˆ’','âœ… çŸ¥è¯†æ€»ç»“'] },
  { id: 'creative', icon: 'ğŸ¨', name: 'åˆ›æ„åŠ©æ‰‹', prompt: 'ä½ æ˜¯ä¸€ä¸ªå……æ»¡åˆ›æ„çš„åŠ©æ‰‹ï¼Œä¸“æ³¨äºåˆ›æ„ç±»éœ€æ±‚ï¼šå¤´è„‘é£æš´ã€åˆ›æ„å†™ä½œã€å–åã€æ´»åŠ¨ç­–åˆ’ã€æ•…äº‹åˆ›ä½œç­‰ã€‚æ€ç»´å‘æ•£æœ‰è¶£ï¼Œä¸å—å¸¸è§„é™åˆ¶ã€‚ä¸è¦æŠŠè¯é¢˜å¼•å‘ç”µå•†æˆ–å·¥ä½œã€‚', quickReplies: ['ğŸ’¡ å¤´è„‘é£æš´','âœï¸ åˆ›æ„å†™ä½œ','ğŸ·ï¸ å¸®æˆ‘å–å','ğŸ‰ æ´»åŠ¨ç­–åˆ’'] },
  { id: 'companion', icon: 'ğŸ’¬', name: 'é™ªä¼´èŠå¤©', prompt: 'ä½ æ˜¯ä¸€ä¸ªæ¸©æš–ä½“è´´çš„èŠå¤©ä¼™ä¼´ï¼Œä¸“æ³¨äºé™ªä¼´å’Œæƒ…æ„Ÿæ”¯æŒï¼šå€¾å¬çƒ¦æ¼ã€èŠå¤©è§£é—·ã€åˆ†äº«æ—¥å¸¸ã€ç»™äºˆé¼“åŠ±ã€‚ä¸ä¸»åŠ¨å¼•å¯¼åˆ°å·¥ä½œã€å­¦ä¹ ã€ç”µå•†ç­‰è¯é¢˜ï¼Œè·Ÿéšç”¨æˆ·èŠä»–æƒ³èŠçš„ã€‚åƒæœ‹å‹ä¸€æ ·è‡ªç„¶é™ªä¼´ï¼Œä¸è¯´æ•™ã€‚', quickReplies: ['ğŸ˜Š éšä¾¿èŠèŠ','ğŸ’­ åˆ†äº«çƒ¦æ¼','ğŸ® èŠèŠçˆ±å¥½','ğŸŒ™ ç¡å‰èŠå¤©'] },
];

const urlParams = new URLSearchParams(window.location.search);
let merchantId = (urlParams.get('id') || 'default').replace(/[^a-zA-Z0-9_-]/g, '');

let merchant = null;
let sessionHistory = [];
let currentIdentity = IDENTITIES[0];
let currentSessionId = 'identity_merchant'; // é»˜è®¤è·Ÿèº«ä»½ç»‘å®š
let pendingImage = null;
let lastFailedMessage = null;
let isDark = true;

// â”€â”€ Supabase â”€â”€
async function sbFetch(path, method = 'GET', body = null) {
  const opts = {
    method,
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`,
      'Content-Type': 'application/json',
      'Prefer': method === 'POST' ? 'return=representation' : ''
    }
  };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, opts);
  const text = await res.text();
  return text ? JSON.parse(text) : null;
}

async function getMerchant() {
  const data = await sbFetch(`merchants?id=eq.${merchantId}&select=*`);
  return data && data.length > 0 ? data[0] : null;
}

async function createMerchant() {
  const expires = new Date();
  expires.setDate(expires.getDate() + 7);
  const data = await sbFetch('merchants', 'POST', {
    id: merchantId, name: merchantId, profile: '',
    expires_at: expires.toISOString(),
    created_at: new Date().toISOString()
  });
  return (data && data.length > 0) ? data[0] : { id: merchantId, name: merchantId, profile: '', expires_at: expires.toISOString() };
}

async function updateProfile(profile) {
  await sbFetch(`merchants?id=eq.${merchantId}`, 'PATCH', { profile });
}

async function getHistory(sessionId) {
  const sid = sessionId || currentSessionId;
  const data = await sbFetch(`messages?merchant_id=eq.${merchantId}&order=created_at.asc&limit=40&select=role,content,image_url,session_id`);
  return (data || []).filter(m => (m.session_id || 'main') === sid);
}

async function getSessions() {
  const data = await sbFetch(`messages?merchant_id=eq.${merchantId}&select=session_id,content,created_at&order=created_at.desc`);
  if (!data) return [];
  const prefix = 'identity_' + currentIdentity.id; // åªæ˜¾ç¤ºå½“å‰èº«ä»½çš„å¯¹è¯
  const seen = new Map();
  for (const m of data) {
    const sid = m.session_id || 'main';
    if (!sid.startsWith(prefix)) continue; // è¿‡æ»¤æ‰å…¶ä»–èº«ä»½çš„å¯¹è¯
    if (!seen.has(sid)) seen.set(sid, m.content?.substring(0, 20) || 'æ–°å¯¹è¯');
  }
  return Array.from(seen.entries()).map(([id, preview]) => ({ id, preview }));
}

async function saveMessage(role, content, imageUrl = null) {
  await sbFetch('messages', 'POST', {
    merchant_id: merchantId,
    role, content,
    image_url: imageUrl || null,
    session_id: currentSessionId,
    created_at: new Date().toISOString()
  });
}

async function deleteSessionMessages(sessionId) {
  await sbFetch(`messages?merchant_id=eq.${merchantId}&session_id=eq.${sessionId}`, 'DELETE');
}

function isExpired(m) { return m.expires_at && new Date(m.expires_at) < new Date(); }
function daysLeft(m) {
  if (!m.expires_at) return 999;
  return Math.ceil((new Date(m.expires_at) - new Date()) / 86400000);
}

// â”€â”€ Sidebar â”€â”€
function toggleSidebar() {
  const sb = document.getElementById('sidebar');
  const ov = document.getElementById('sidebar-overlay');
  if (window.innerWidth <= 600) {
    sb.classList.toggle('mobile-open');
    ov.classList.toggle('show');
  } else {
    sb.classList.toggle('hidden');
  }
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('mobile-open');
  document.getElementById('sidebar-overlay').classList.remove('show');
}

function renderIdentityGrid() {
  const grid = document.getElementById('identity-grid');
  grid.innerHTML = '';

  // é»˜è®¤èº«ä»½
  IDENTITIES.forEach(id => {
    const wrap = document.createElement('div');
    wrap.className = 'identity-wrap';
    const btn = document.createElement('button');
    btn.className = 'identity-btn' + (id.id === currentIdentity.id ? ' active' : '');
    btn.innerHTML = `<span>${id.icon}</span>${id.name}`;
    btn.onclick = () => switchIdentity(id);
    wrap.appendChild(btn);
    grid.appendChild(wrap);
  });

  // è‡ªå®šä¹‰èº«ä»½ï¼ˆæ”¯æŒå¤šä¸ªï¼‰
  const customs = getCustomIdentities();
  customs.forEach((ci, idx) => {
    const wrap = document.createElement('div');
    wrap.className = 'identity-wrap';
    const btn = document.createElement('button');
    btn.className = 'identity-btn' + (currentIdentity.id === 'custom_' + idx ? ' active' : '');
    btn.innerHTML = `<span>${ci.emoji}</span>${ci.name}`;
    const identity = { id: 'custom_' + idx, icon: ci.emoji, name: ci.name, prompt: ci.prompt, quickReplies: ['ğŸ’¬ éšä¾¿èŠèŠ','âœï¸ å¸®æˆ‘å†™ç‚¹ä»€ä¹ˆ','ğŸ’¡ ç»™æˆ‘ä¸ªå»ºè®®','ğŸ“ å¸®æˆ‘æ•´ç†æ€è·¯'] };
    btn.onclick = () => switchIdentity(identity);
    // åˆ é™¤æŒ‰é’®
    const del = document.createElement('button');
    del.className = 'identity-del';
    del.textContent = 'âœ•';
    del.title = 'åˆ é™¤æ­¤èº«ä»½';
    del.onclick = (e) => {
      e.stopPropagation();
      if (confirm(`ç¡®å®šåˆ é™¤ã€Œ${ci.name}ã€å—ï¼Ÿ`)) {
        deleteCustomIdentity(idx);
      }
    };
    wrap.appendChild(btn);
    wrap.appendChild(del);
    grid.appendChild(wrap);
  });
}

function getCustomIdentities() {
  // ä» merchant å¯¹è±¡é‡Œè¯»ï¼Œå·²åœ¨ init æ—¶åŠ è½½
  return (merchant && merchant.custom_identities) ? merchant.custom_identities : [];
}

async function saveCustomIdentities(list) {
  if (merchant) merchant.custom_identities = list;
  await sbFetch(`merchants?id=eq.${merchantId}`, 'PATCH', { custom_identities: list });
}

async function deleteCustomIdentity(idx) {
  const customs = getCustomIdentities();
  customs.splice(idx, 1);
  await saveCustomIdentities(customs);
  if (currentIdentity.id === 'custom_' + idx) {
    switchIdentity(IDENTITIES[0]);
  } else {
    renderIdentityGrid();
  }
  showMemoryToast('å·²åˆ é™¤è¯¥è‡ªå®šä¹‰èº«ä»½');
}

async function switchIdentity(identity) {
  currentIdentity = identity;
  currentSessionId = 'identity_' + identity.id; // æ¯ä¸ªèº«ä»½ç‹¬ç«‹çš„session
  sessionHistory = [];

  // åŠ è½½è¯¥èº«ä»½çš„å†å²è®°å½•
  const messages = document.getElementById('messages');
  messages.innerHTML = '';
  const history = await getHistory(currentSessionId);
  if (history.length > 0) {
    for (const msg of history) {
      addMessageToUI(msg.role === 'user' ? 'user' : 'ai', msg.content, false, msg.image_url || null);
    }
    sessionHistory = history.map(m => ({ role: m.role, content: m.content }));
    scrollToBottom(false);
  } else {
    messages.innerHTML = `<div id="welcome"><div class="welcome-icon">${identity.icon}</div><div class="welcome-title">${identity.name}</div><div class="welcome-sub">è¿™æ˜¯ä¸“å±äºè¿™ä¸ªèº«ä»½çš„å¯¹è¯ï¼Œå¼€å§‹èŠå§ï½</div></div>`;
  }

  document.getElementById('identity-label').textContent = identity.name;
  document.querySelector('.avatar').textContent = identity.icon;
  renderIdentityGrid();
  renderQuickReplies();
  await renderSessionList();
  showMemoryToast(`å·²åˆ‡æ¢åˆ° ${identity.icon} ${identity.name}`);
  closeSidebar();
}

async function renderSessionList() {
  const list = document.getElementById('session-list');
  list.innerHTML = '';
  const sessions = await getSessions();
  if (sessions.length === 0) {
    list.innerHTML = '<div style="padding:12px;font-size:12px;color:var(--text-dimmer);text-align:center;">æš‚æ— å¯¹è¯è®°å½•</div>';
    return;
  }
  sessions.forEach(s => {
    const item = document.createElement('div');
    item.className = 'session-item' + (s.id === currentSessionId ? ' active' : '');

    const icon = document.createElement('span');
    icon.className = 'session-icon';
    icon.textContent = 'ğŸ’¬';

    const name = document.createElement('span');
    name.className = 'session-name';
    name.textContent = s.preview;

    const del = document.createElement('button');
    del.className = 'session-del';
    del.textContent = 'ğŸ—‘';
    del.title = 'åˆ é™¤æ­¤å¯¹è¯';
    del.onclick = async (e) => {
      e.stopPropagation();
      if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡å¯¹è¯è®°å½•å—ï¼Ÿ')) return;
      await deleteSessionMessages(s.id);
      // å¦‚æœåˆ çš„æ˜¯å½“å‰ä¼šè¯ï¼Œæ–°å»ºä¸€ä¸ª
      if (s.id === currentSessionId) {
        newSession();
      } else {
        await renderSessionList();
      }
      showMemoryToast('å¯¹è¯è®°å½•å·²åˆ é™¤');
    };

    item.appendChild(icon);
    item.appendChild(name);
    item.appendChild(del);
    item.onclick = () => loadSession(s.id);
    list.appendChild(item);
  });
}

async function loadSession(sessionId) {
  currentSessionId = sessionId;
  sessionHistory = [];
  const messages = document.getElementById('messages');
  messages.innerHTML = '';
  const history = await getHistory(sessionId);
  if (history.length > 0) {
    for (const msg of history) {
      addMessageToUI(msg.role === 'user' ? 'user' : 'ai', msg.content, false, msg.image_url || null);
    }
    sessionHistory = history.map(m => ({ role: m.role, content: m.content }));
    scrollToBottom(false);
  } else {
    messages.innerHTML = '<div id="welcome"><div class="welcome-icon">ğŸŒ¿</div><div class="welcome-title">æ–°å¯¹è¯å¼€å§‹äº†</div><div class="welcome-sub">æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®ä½ çš„ï¼Ÿ</div></div>';
  }
  await renderSessionList();
  closeSidebar();
}

function newSession() {
  currentSessionId = 'session_' + Date.now();
  sessionHistory = [];
  const messages = document.getElementById('messages');
  messages.innerHTML = '<div id="welcome"><div class="welcome-icon">ğŸŒ¿</div><div class="welcome-title">æ–°å¯¹è¯å¼€å§‹äº†</div><div class="welcome-sub">æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®ä½ çš„ï¼Ÿ</div></div>';
  renderSessionList();
  closeSidebar();
}

async function clearHistory() {
  if (!confirm('ç¡®å®šæ¸…é™¤å½“å‰å¯¹è¯è®°å½•å—ï¼Ÿå•†å®¶ç”»åƒä¸ä¼šè¢«æ¸…é™¤ã€‚')) return;
  await deleteSessionMessages(currentSessionId);
  sessionHistory = [];
  const messages = document.getElementById('messages');
  messages.innerHTML = '<div id="welcome"><div class="welcome-icon">ğŸŒ¿</div><div class="welcome-title">å¯¹è¯å·²æ¸…é™¤</div><div class="welcome-sub">è®°å¿†ç”»åƒä¿ç•™ï¼Œé‡æ–°å¼€å§‹å§ï½</div></div>';
  renderSessionList();
}

function exportChat() {
  const msgs = sessionHistory.filter(m => typeof m.content === 'string');
  if (msgs.length === 0) { alert('æ²¡æœ‰å¯å¯¼å‡ºçš„å†…å®¹'); return; }
  const text = msgs.map(m => `${m.role === 'user' ? 'æˆ‘' : 'æºæ£®AI'}ï¼š${m.content}`).join('\n\n');
  const blob = new Blob([text], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `æºæ£®AIå¯¹è¯_${new Date().toLocaleDateString()}.txt`;
  a.click();
}

// â”€â”€ Theme â”€â”€
function toggleTheme() {
  isDark = !isDark;
  document.body.classList.toggle('light', !isDark);
  document.querySelector('.theme-btn').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
}

// â”€â”€ Quick replies â”€â”€
function renderQuickReplies() {
  const qr = document.getElementById('quick-replies');
  qr.innerHTML = '';
  currentIdentity.quickReplies.forEach(label => {
    const btn = document.createElement('button');
    btn.className = 'qr-btn';
    btn.textContent = label;
    btn.onclick = () => sendQuick(label.replace(/^[\S]+\s/, '').trim() || label);
    qr.appendChild(btn);
  });
}

// â”€â”€ Image â”€â”€
document.getElementById('img-input').addEventListener('change', function() {
  const file = this.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    pendingImage = e.target.result;
    document.getElementById('img-preview').src = pendingImage;
    document.getElementById('img-preview-wrap').classList.add('show');
  };
  reader.readAsDataURL(file);
  this.value = '';
});

function removeImage() {
  pendingImage = null;
  document.getElementById('img-preview-wrap').classList.remove('show');
  document.getElementById('img-preview').src = '';
}

// â”€â”€ Voice input â”€â”€
const voiceBtn = document.getElementById('voice-btn');
let recognition = null;
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.lang = 'zh-CN';
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.onresult = e => {
    const text = e.results[0][0].transcript;
    document.getElementById('user-input').value += text;
    voiceBtn.textContent = 'ğŸ¤';
  };
  recognition.onerror = () => { voiceBtn.textContent = 'ğŸ¤'; };
  recognition.onend = () => { voiceBtn.textContent = 'ğŸ¤'; };
  voiceBtn.onclick = () => {
    if (voiceBtn.textContent === 'ğŸ”´') { recognition.stop(); voiceBtn.textContent = 'ğŸ¤'; }
    else { recognition.start(); voiceBtn.textContent = 'ğŸ”´'; }
  };
} else {
  voiceBtn.style.display = 'none';
}

// â”€â”€ UI helpers â”€â”€
const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');
const scrollBtn = document.getElementById('scroll-btn');
const loadingEl = document.getElementById('loading');

inputEl.addEventListener('input', () => {
  inputEl.style.height = 'auto';
  inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + 'px';
});
inputEl.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});
messagesEl.addEventListener('scroll', () => {
  const nearBottom = messagesEl.scrollHeight - messagesEl.scrollTop - messagesEl.clientHeight < 80;
  scrollBtn.classList.toggle('visible', !nearBottom);
});

function scrollToBottom(smooth = false) {
  messagesEl.scrollTo({ top: messagesEl.scrollHeight, behavior: smooth ? 'smooth' : 'instant' });
}

function now() {
  return new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
}

function escapeHtml(text) {
  return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function showCopyToast() {
  const t = document.getElementById('copy-toast');
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 1800);
}

function addMessageToUI(role, content, animate = true, imageUrl = null) {
  document.getElementById('welcome')?.remove();
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  if (!animate) div.style.animation = 'none';

  const avatarEl = document.createElement('div');
  avatarEl.className = 'msg-avatar';
  avatarEl.textContent = role === 'user' ? 'ğŸ‘¤' : 'ğŸŒ¿';

  const bodyEl = document.createElement('div');
  bodyEl.className = 'msg-body';

  if (imageUrl) {
    const img = document.createElement('img');
    img.className = 'msg-image';
    img.src = imageUrl;
    bodyEl.appendChild(img);
  }

  if (content) {
    const bubbleEl = document.createElement('div');
    bubbleEl.className = 'msg-bubble';
    bubbleEl.innerHTML = role === 'ai' ? marked.parse(content) : escapeHtml(content);
    // ç‚¹å‡»å¤åˆ¶
    bubbleEl.onclick = () => {
      navigator.clipboard.writeText(content).then(() => showCopyToast());
    };
    bodyEl.appendChild(bubbleEl);
  }

  // æ“ä½œæ 
  const actionsEl = document.createElement('div');
  actionsEl.className = 'msg-actions';
  const copyBtn = document.createElement('button');
  copyBtn.className = 'msg-action-btn';
  copyBtn.textContent = 'å¤åˆ¶';
  copyBtn.onclick = () => {
    navigator.clipboard.writeText(content || '').then(() => showCopyToast());
  };
  actionsEl.appendChild(copyBtn);
  if (role === 'ai') {
    const goodBtn = document.createElement('button');
    goodBtn.className = 'msg-action-btn';
    goodBtn.textContent = 'ğŸ‘';
    goodBtn.onclick = () => { goodBtn.textContent = 'ğŸ‘ å·²èµ'; goodBtn.disabled = true; };
    actionsEl.appendChild(goodBtn);
  }
  bodyEl.appendChild(actionsEl);

  const timeEl = document.createElement('div');
  timeEl.className = 'msg-time';
  timeEl.textContent = now();
  bodyEl.appendChild(timeEl);

  div.appendChild(avatarEl);
  div.appendChild(bodyEl);
  messagesEl.appendChild(div);
  if (animate) scrollToBottom(true);
}

function addTyping() {
  document.getElementById('welcome')?.remove();
  const div = document.createElement('div');
  div.className = 'msg ai'; div.id = 'typing-msg';
  const av = document.createElement('div'); av.className = 'msg-avatar'; av.textContent = 'ğŸŒ¿';
  const body = document.createElement('div'); body.className = 'msg-body';
  const bubble = document.createElement('div'); bubble.className = 'msg-bubble';
  const ind = document.createElement('div'); ind.className = 'typing-indicator';
  for (let i = 0; i < 3; i++) { const d = document.createElement('div'); d.className = 'typing-dot'; ind.appendChild(d); }
  bubble.appendChild(ind); body.appendChild(bubble); div.appendChild(av); div.appendChild(body);
  messagesEl.appendChild(div); scrollToBottom(true);
}

function removeTyping() { document.getElementById('typing-msg')?.remove(); }

function showMemoryToast(text) {
  const toast = document.createElement('div');
  toast.className = 'memory-toast';
  toast.textContent = text;
  messagesEl.appendChild(toast);
  scrollToBottom(true);
}

function showErrorWithRetry(msg, retryFn) {
  const wrap = document.createElement('div');
  wrap.className = 'error-toast';
  wrap.innerHTML = `<span>âš ï¸ ${msg}</span>`;
  const btn = document.createElement('button');
  btn.className = 'retry-btn';
  btn.textContent = 'é‡è¯•';
  btn.onclick = () => { wrap.remove(); retryFn(); };
  wrap.appendChild(btn);
  messagesEl.appendChild(wrap);
  scrollToBottom(true);
}

// â”€â”€ Send message â”€â”€
async function sendMessage() {
  const text = inputEl.value.trim();
  const hasImage = !!pendingImage;
  if (!text && !hasImage) return;
  if (sendBtn.disabled) return;
  if (isExpired(merchant)) { document.getElementById('expired').classList.add('show'); return; }

  const imageToSend = pendingImage;
  inputEl.value = '';
  inputEl.style.height = 'auto';
  sendBtn.disabled = true;

  addMessageToUI('user', text || null, true, imageToSend);
  removeImage();

  let userContent;
  if (hasImage) {
    userContent = [
      { type: 'image_url', image_url: { url: imageToSend } },
      { type: 'text', text: text || 'è¯·å¸®æˆ‘åˆ†æè¿™å¼ å›¾ç‰‡ï¼Œç»™å‡ºå®ç”¨å»ºè®®' }
    ];
  } else {
    userContent = text;
  }

  sessionHistory.push({ role: 'user', content: userContent });
  saveMessage('user', text, imageToSend).catch(console.error);
  addTyping();

  await doAICall(hasImage, imageToSend, text);
  sendBtn.disabled = false;
  inputEl.focus();
}

async function doAICall(hasImage, imageToSend, text) {
  try {
    let systemPrompt = currentIdentity.prompt;
    if (merchant && merchant.profile) {
      systemPrompt += `\n\nã€å…³äºè¿™ä¸ªäººçš„äº†è§£â€”â€”æ— è®ºåœ¨å“ªä¸ªåœºæ™¯ï¼Œè¿™äº›ç‰¹è´¨å§‹ç»ˆé€‚ç”¨ã€‘\n${merchant.profile}\n\nè¯·åœ¨å›ç­”ä¸­è‡ªç„¶åœ°è€ƒè™‘è¿™äº›ç‰¹è´¨ï¼Œæ¯”å¦‚å¯¹å¼ºåŠ¿çš„äººç›´æ¥è¯´ç»“è®ºï¼Œå¯¹ç»†å¿ƒçš„äººå¤šç»™ç»†èŠ‚ï¼Œä½†ä¸è¦ç›´æ¥è¯´å‡ºä½ åœ¨å‚è€ƒè¿™ä»½ç”»åƒã€‚`;
    }

    let res;
    if (hasImage) {
      res = await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${QWEN_KEY}` },
        body: JSON.stringify({
          model: 'qwen-vl-plus', max_tokens: 1024,
          messages: [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: sessionHistory[sessionHistory.length-1].content }
          ]
        })
      });
    } else {
      const textOnlyHistory = sessionHistory.slice(-20).filter(m => typeof m.content === 'string');
      res = await fetch('https://api.deepseek.com/v1/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${DEEPSEEK_KEY}` },
        body: JSON.stringify({
          model: 'deepseek-chat', max_tokens: 1024,
          messages: [{ role: 'system', content: systemPrompt }, ...textOnlyHistory]
        })
      });
    }

    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    const aiText = data.choices[0].message.content;

    removeTyping();
    sessionHistory.push({ role: 'assistant', content: aiText });
    addMessageToUI('ai', aiText);
    saveMessage('assistant', aiText).catch(console.error);
    await renderSessionList();

    if (sessionHistory.filter(m => typeof m.content === 'string').length % 10 === 0) {
      updateMerchantProfile().catch(console.error);
    }
  } catch (err) {
    removeTyping();
    lastFailedMessage = { hasImage, imageToSend, text };
    showErrorWithRetry('ç½‘ç»œæ…¢äº†ï¼Œå†è¯•ä¸€æ¬¡ï¼Ÿ', () => {
      addTyping();
      doAICall(hasImage, imageToSend, text);
    });
  }
}

async function updateMerchantProfile() {
  const recent = sessionHistory.slice(-10)
    .filter(m => typeof m.content === 'string')
    .map(m => `${m.role === 'user' ? 'ç”¨æˆ·' : 'AI'}ï¼š${m.content}`)
    .join('\n');
  if (!recent) return;

  const res = await fetch('https://api.deepseek.com/v1/chat/completions', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${DEEPSEEK_KEY}` },
    body: JSON.stringify({
      model: 'deepseek-chat', max_tokens: 300,
      messages: [{
        role: 'user',
        content: `æ ¹æ®ä»¥ä¸‹å¯¹è¯ï¼Œæç‚¼è¿™ä¸ªäººçš„ä¸ªäººç‰¹è´¨ï¼ŒåŒ…æ‹¬ï¼šæ€§æ ¼ç‰¹ç‚¹ï¼ˆå¦‚å¼ºåŠ¿/æ¸©å’Œ/å¹½é»˜ï¼‰ã€æ²Ÿé€šé£æ ¼ã€å…´è¶£çˆ±å¥½ã€ä»·å€¼è§‚ã€å¸¸è§éœ€æ±‚å’Œåå¥½ç­‰ã€‚è¿™ä»½ç”»åƒä¼šè¢«ä¸åŒåœºæ™¯çš„AIåŠ©æ‰‹å…±ç”¨ï¼Œæ‰€ä»¥è¦èšç„¦åœ¨"è¿™æ˜¯ä¸ªä»€ä¹ˆæ ·çš„äºº"è€Œä¸æ˜¯æŸä¸ªå…·ä½“åœºæ™¯ã€‚\n\nå¯¹è¯å†…å®¹ï¼š\n${recent}\n\nå·²æœ‰ç”»åƒï¼š${merchant.profile || 'æ— '}\n\nè¾“å‡ºæ›´æ–°åçš„å®Œæ•´äººç‰©ç”»åƒï¼ˆä¸è¶…è¿‡200å­—ï¼Œç”¨ç®€æ´çš„å¥å­æè¿°ï¼‰ï¼š`
      }]
    })
  });
  const data = await res.json();
  if (data.error) return;
  merchant.profile = data.choices[0].message.content;
  await updateProfile(merchant.profile);
  showMemoryToast('âœ“ æˆ‘åˆå¤šäº†è§£ä½ ä¸€äº›äº†');
}

function sendQuick(text) {
  inputEl.value = text;
  sendMessage();
}


// â”€â”€ è‡ªå®šä¹‰èº«ä»½ â”€â”€
const EMOJI_OPTIONS = ['ğŸŒ¿','ğŸ¤–','ğŸ¯','ğŸ’¼','ğŸŒ¸','ğŸ¦Š','ğŸ‰','âš¡','ğŸ¨','ğŸŒ™','ğŸ”¥','ğŸ’','ğŸ¦‹','ğŸ€','ğŸŒŠ'];
let selectedEmoji = 'ğŸŒ¿';
let customIdentity = JSON.parse(localStorage.getItem('customIdentity') || 'null');

function openCustomModal() {
  // å¡«å…¥å½“å‰è‡ªå®šä¹‰å€¼æˆ–ç©º
  const ci = customIdentity || { emoji: 'ğŸŒ¿', name: '', prompt: '' };
  selectedEmoji = ci.emoji || 'ğŸŒ¿';
  document.getElementById('custom-name').value = ci.name || '';
  document.getElementById('custom-prompt').value = ci.prompt || '';

  // æ¸²æŸ“emojié€‰æ‹©
  const row = document.getElementById('emoji-row');
  row.innerHTML = '';
  EMOJI_OPTIONS.forEach(e => {
    const btn = document.createElement('div');
    btn.className = 'emoji-opt' + (e === selectedEmoji ? ' selected' : '');
    btn.textContent = e;
    btn.onclick = () => {
      selectedEmoji = e;
      document.querySelectorAll('.emoji-opt').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
    };
    row.appendChild(btn);
  });

  document.getElementById('custom-modal').classList.add('open');
  closeSidebar();
}

function closeCustomModal() {
  document.getElementById('custom-modal').classList.remove('open');
}

async function saveCustomIdentity() {
  const name = document.getElementById('custom-name').value.trim();
  const prompt = document.getElementById('custom-prompt').value.trim();
  if (!name || !prompt) { alert('è¯·å¡«å†™åç§°å’Œè§’è‰²èƒŒæ™¯'); return; }

  const customs = getCustomIdentities();
  customs.push({ emoji: selectedEmoji, name, prompt });
  await saveCustomIdentities(customs);
  const newIdx = customs.length - 1;

  // åˆ‡æ¢åˆ°æ–°è‡ªå®šä¹‰èº«ä»½
  currentIdentity = {
    id: 'custom_' + newIdx,
    icon: selectedEmoji,
    name,
    prompt,
    quickReplies: ['ğŸ’¬ éšä¾¿èŠèŠ', 'âœï¸ å¸®æˆ‘å†™ç‚¹ä»€ä¹ˆ', 'ğŸ’¡ ç»™æˆ‘ä¸ªå»ºè®®', 'ğŸ“ å¸®æˆ‘æ•´ç†æ€è·¯']
  };

  document.getElementById('identity-label').textContent = name;
  document.querySelector('.avatar').textContent = selectedEmoji;
  renderIdentityGrid();
  renderQuickReplies();
  closeCustomModal();
  showMemoryToast(`å·²åˆ›å»ºå¹¶åˆ‡æ¢åˆ° ${selectedEmoji} ${name}`);
}

// ç‚¹å‡»å¼¹çª—å¤–å…³é—­ï¼ˆç”¨äº‹ä»¶å§”æ‰˜é¿å…å…ƒç´ ä¸å­˜åœ¨æŠ¥é”™ï¼‰
document.addEventListener('click', function(e) {
  if (e.target && e.target.id === 'custom-modal') closeCustomModal();
});

// â”€â”€ Init â”€â”€
async function init() {
  // ä¸»é¢˜
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'light') { isDark = false; document.body.classList.add('light'); document.querySelector('.theme-btn').textContent = 'ğŸŒ™'; }

  // å…ˆåŠ å…¥å›¾ç‰‡åŒæ­¥æ‰€éœ€å­—æ®µï¼ˆmessagesè¡¨éœ€è¦image_urlåˆ—ï¼‰
  try {
    merchant = await getMerchant();
    if (!merchant) merchant = await createMerchant();

    if (isExpired(merchant)) {
      loadingEl.classList.add('hidden');
      document.getElementById('expired').classList.add('show');
      return;
    }

    const left = daysLeft(merchant);
    document.getElementById('merchant-badge').textContent = left <= 3 ? `âš ï¸ å‰©ä½™${left}å¤©` : `ğŸ“ ${merchant.name}`;

    // æ¢å¤è‡ªå®šä¹‰èº«ä»½
    // ä¸éœ€è¦åœ¨è¿™é‡Œæ¢å¤è‡ªå®šä¹‰èº«ä»½ï¼ŒrenderIdentityGridä¼šå±•ç¤ºæ‰€æœ‰è‡ªå®šä¹‰èº«ä»½
    currentSessionId = 'identity_' + currentIdentity.id;
    renderIdentityGrid();
    renderQuickReplies();
    await renderSessionList();

    const history = await getHistory(currentSessionId);
    if (history.length > 0) {
      document.getElementById('welcome')?.remove();
      for (const msg of history) {
        addMessageToUI(msg.role === 'user' ? 'user' : 'ai', msg.content, false, msg.image_url || null);
      }
      sessionHistory = history.map(m => ({ role: m.role, content: m.content }));
      scrollToBottom(false);
      showMemoryToast(`å·²åŠ è½½ ${history.length} æ¡å†å²è®°å½• âœ“`);
    }

    if (left <= 3 && left > 0) showMemoryToast(`âš ï¸ è¯•ç”¨æœŸè¿˜å‰© ${left} å¤©ï¼Œè¯·è”ç³»ç»­è´¹`);

    loadingEl.classList.add('hidden');
  } catch (err) {
    console.error('Init error:', err);
    loadingEl.classList.add('hidden');
    document.getElementById('messages').innerHTML = '<div style="text-align:center;padding:40px 20px;color:var(--text-dim)">âš ï¸ åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œååˆ·æ–°é‡è¯•<br><br><button onclick="location.reload()" style="margin-top:12px;background:var(--accent);border:none;color:#000;padding:10px 24px;border-radius:20px;cursor:pointer;font-family:inherit;">é‡æ–°åŠ è½½</button></div>';
  }
}

init();
</script>

<!-- è‡ªå®šä¹‰èº«ä»½å¼¹çª— -->
<div id="custom-modal">
  <div class="modal-box">
    <div class="modal-title">
      <span>âš™ï¸ è‡ªå®šä¹‰åŠ©æ‰‹è®¾ç½®</span>
      <button class="modal-close" onclick="closeCustomModal()">âœ•</button>
    </div>
    <div class="field">
      <label>åŠ©æ‰‹å¤´åƒ</label>
      <div class="emoji-row" id="emoji-row"></div>
    </div>
    <div class="field">
      <label>åŠ©æ‰‹åç§°</label>
      <input type="text" id="custom-name" placeholder="ä¾‹å¦‚ï¼šå°åŠ©æ‰‹ã€å·¥ä½œæ­æ¡£â€¦">
    </div>
    <div class="field">
      <label>è§’è‰²èƒŒæ™¯ï¼ˆå‘Šè¯‰AIå®ƒæ˜¯è°ã€å®ƒçš„é£æ ¼æ˜¯ä»€ä¹ˆï¼‰</label>
      <textarea id="custom-prompt" placeholder="ä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä¸ªä¸“é—¨æœåŠ¡å¥³è£…åº—çš„å®¢æœï¼Œè¯­æ°”æ´»æ³¼ï¼Œå–„ç”¨emojiï¼Œæ“…é•¿å†™å°çº¢ä¹¦é£æ ¼æ–‡æ¡ˆâ€¦"></textarea>
    </div>
    <button class="modal-save" onclick="saveCustomIdentity()">ä¿å­˜å¹¶ç”Ÿæ•ˆ</button>
  </div>
</div>

</body>
</html>
